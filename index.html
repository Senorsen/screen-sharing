<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>技术研发中心</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
    }
    #pointer {
        position: absolute;
        top: 0;
        left: 0;
    }
</style>
<script src="jquery-2.1.1.min.js"></script>
<script>
    var resetCanvas = function() {
        var canvas = document.getElementById('main');
        (canvas.width == screen.availWidth) ? 0 : (canvas.width = screen.availWidth);
        (canvas.height == screen.availHeight) ? 0 : (canvas.height = screen.availHeight);
    };
    setInterval(resetCanvas, 1000);
    var getCanvas = function() {
        if (typeof window.myCanvas != 'undefined') {
            return window.myCanvas;
        } else {
            return window.myCanvas = document.getElementById('main');
        }
    };
    var getContext = function() {
        var canvas = getCanvas();
        return (typeof window.myContext != 'undefined') ? window.myContext : (window.myContext = canvas.getContext('2d'));
    };
    var getStaticImage = function(num, posx, poxy) {
        var context = getContext();
        var image = new Image();
        image.src = 'tmp/' + num + '.jpg?_=' + jQuery.now();
        image.onload = function() {
            context.drawImage(this, posx, posy);
        };
    };
    var setPointer = function(posx, posy) {
        $('#pointer').css({left: posx, top: posy});
    };
    var startFetch = function(start) {
        if (start == 0) start = 'current';
        $.get('tmp/' + start + '.json?_=' + jQuery.now(), null, function(data) {
            var newest = data.newest;
            getStaticImage(newest, 0, 0);
            if (data.now > data.newest) {
                for (var i = 0; i < data.updates; i++) {
                    getStaticImage('' + newest + '_' + i, data.diff[i][0], data.diff[i][1]);
                }
            }
            setPointer(data.pointer[0], data.pointer[1]);
        }, 'json');
    };
</script>
</head>
<body>
    <canvas id="main"></canvas>
    <div id="pointer"></div>
</body>
</html>
